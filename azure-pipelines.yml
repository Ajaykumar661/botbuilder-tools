name: Experimental-Push-$(Date:yyyyMMdd)$(Rev:.r)
variables:
  var1: value1
jobs:
- job: Job_1
  displayName: Packages
  pool:
    name: Hosted VS2017
  condition: succeeded()
  variables:
    testvar1: "testVal1"
  steps:
  - powershell: echo "##vso[task.setvariable variable=myOutputVar;isOutput=true]this is the value"
    name: setvarStep
  - task: DownloadBuildArtifacts@0
    displayName: 'Download Build Artifacts'
    inputs:
      buildType: specific
      project: '86659c66-c9df-418a-a371-7de7aed35064'
      pipeline: 467
      downloadType: specific

  - powershell: |  
       [string[]]$outvar = (Get-ChildItem *.tgz -Path $(System.ArtifactsDirectory)\drop ).Name;
       [int] $j = $outvar.Length;
       $PackagesDescription = "Pushing $j packages";
       Write-Host $PackagesDescription
       "##vso[task.setvariable variable=PackagesDescription;]$PackagesDescription";
       "##vso[task.setvariable variable=PackagesDescriptionO;isOutput=true;]$PackagesDescription";
       
       for ($i = 0; $i -lt $outvar.Length; $i++ ) {
           $p = "pkg$i"
           Write-Host $p
           $pO = "pkg$iO"
           Write-Host $pO
           $n = $outvar[$i];
           "##vso[task.setvariable variable=$p;]$n";
           "##vso[task.setvariable variable=$pO;isOutput=true;]$n";
           Write-Host $n
       }
       for ($i = $outvar.Length; $i -lt 15; $i++ ) {
           $p = "pkg$i"
           $pO = "pkg$iO"
           "##vso[task.setvariable variable=$p;]";
           "##vso[task.setvariable variable=$pO;isOutput=true;]";
       }
    name: getPackageNames
    displayName: 'Get package names'

  - script: |  
       echo $(setvarStep.myOutputVar)
       echo $(getPackageNames.PackagesDescriptionO)
       echo $(getPackageNames.pkg0O)
       echo $(getPackageNames.pkg1O)
    name: echovar
  - powershell: 'Get-ChildItem env:* | sort-object name | Format-Table -Autosize'
    displayName: 'Display env vars'
    continueOnError: true
    condition: succeededOrFailed()

  - task: colinsalmcorner.colinsalmcorner-buildtasks.tag-build-task.tagBuildOrRelease@0
    displayName: 'Tag Build with package names'
    inputs:
      tags: |  
       $(PACKAGESDESCRIPTION)
       $(PKG0)
       $(PKG1)
       $(PKG2)
       $(PKG3)
       $(PKG4)
       $(PKG5)
       $(PKG6)
       $(PKG7)
       $(PKG8)
       $(PKG9)
       $(PKG10)
       $(PKG11)
       $(PKG12)
       $(PKG13)
       $(PKG14)
    continueOnError: true

  - powershell: 'gci env:* | sort-object name'
    displayName: 'Display env vars'

  - powershell: |  
       pushd ..
       Get-ChildItem -Recurse -Force
    displayName: 'Dir workspace'
    continueOnError: true
    condition: succeededOrFailed()

  - powershell: |  
       pushd $(Agent.TempDirectory)
       Get-ChildItem -Recurse -Force
    displayName: 'Dir $(Agent.TempDirectory)'
    enabled: false
    continueOnError: true
    condition: succeededOrFailed()


- job: Job_2
  displayName: Verify
  dependsOn: Job_1
  condition: succeeded()
  pool: server
  variables:
    testVar2: "testVal2"

  steps:
  - task: InvokeRESTAPI@1
    displayName: 'View packages to be pushed'
    inputs:
      serviceConnection: 'SDK_v4 release REST API'
      method: GET
      urlSuffix: '/releases/599/tags?api-version=5.0-preview'
  

- job: Job_3
  displayName: Push
  pool:
    name: Hosted VS2017
  dependsOn: [Job_1,Job_2]
  condition: succeeded()
  variables:
    myVarFromJobA: $[ dependencies.Job_1.outputs['setvarStep.myOutputVar'] ]  # map in the variable
    testvar3: "testVal3"
    job1PackDescription: $[ dependencies.Job_1.outputs['getPackageNames.PackagesDescription'] ]
    job1Pkg0: $[ dependencies.Job_1.outputs['getPackageNames.pkg0'] ]
    job1PackDescriptionO: $[ dependencies.Job_1.outputs['getPackageNames.PackagesDescriptionO'] ]
    job1Pkg0O: $[ dependencies.Job_1.outputs['getPackageNames.PKG0O'] ]

  steps:
  - script: echo $(myVarFromJobA)
    name: echovar
  - powershell: 'gci env:* | sort-object name'
    displayName: 'Display env vars'
  - script: |  
      echo $(job1PackDescription)
      echo $(job1PackDescriptionO)
      echo $(job1Pkg0O)
    name: echovar2
  - task: DownloadBuildArtifacts@0
    displayName: 'Download Build Artifacts copy'
    inputs:
      buildType: specific
      project: '86659c66-c9df-418a-a371-7de7aed35064'
      pipeline: 467
      downloadType: specific

  - powershell: |  
       Set-Location -Path "$(System.ArtifactsDirectory)\drop";
       New-Item -Path . -Name ".npmrc" -ItemType "file" -Value "registry=https://botbuilder.myget.org/F/scratch/npm/";
    displayName: 'Create .npmrc for MyGet scratch publish'

  - task: npmAuthenticate@0
    displayName: 'Authenticate for NPM publish'
    inputs:
      workingFile: '$(System.ArtifactsDirectory)\drop\.npmrc'
      customEndpoint: 'MyGet scratch npm feed'

  - powershell: |  
       Set-Location -Path "$(System.ArtifactsDirectory)\drop";
       Get-ChildItem . -Filter *.tgz | 
       Foreach-Object {
           Write-Host "Pushing:" $_.FullName;
           npm publish $_.FullName;
       }
    displayName: 'Publish *.tgz '
    enabled: false

  - powershell: |  
       pushd ..
       Get-ChildItem -Recurse -Force
    displayName: 'Dir workspace copy'
    continueOnError: true
    condition: succeededOrFailed()

